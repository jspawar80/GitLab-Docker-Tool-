<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deploy App</title>
    <style>
        table,
        th,
        td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 5px;
        }
    </style>
</head>

<style>
    /* Styles for the loading overlay */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1000;
    }

    .loading-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 24px;
    }
    textarea {
        resize: none;
        overflow: hidden;
        min-height: 50px;
        max-height: 100px;
    }
</style>

<body>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Branches</th>
                <th>Container Status</th>
                <!-- <th>Env</th> -->
                <th>Deploy</th>
                <th>Remove Container</th>
            </tr>
        </thead>
        <tbody id="reposTableBody">
            <!-- Rows will be dynamically added here -->
        </tbody>
    </table>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-message">Loading...</div>
    </div>

    <script>
        function auto_grow(element) {
            element.style.height = "5px";
            element.style.height = (element.scrollHeight) + "px";
        }
        // Sample data for repositories and branches
        const repos = [
            { url: "git@gitlab.intelliflow.in:intelliflow/if-connector-svc.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/if-excel-svc.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/if-gateway-svc.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/if-identity-mgr.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/if-upgrade-svc.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifa-data-mgr.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifa-notification-mgr.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifa-odata-svc.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifs-bpmn-validator-svc.git"},
            { url: " git@gitlab.intelliflow.in:intelliflow/ifs-bulk-service.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifs-cds-mgr.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifs-chat-svc.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifs-deployment-manager.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifs-dmn-validator.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifs-genesis-app.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/interapp-comm-service.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifs-kube-monitor.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifs-miniapp-deploy.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifs-modeller-svc.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifs-process-manager.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifs-reportbuilder-svc.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifs-repository-manager.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifs-router-svc.git"},
            { url: "git@gitlab.intelliflow.in:intelliflow/ifs-vault-svc.git" },
            { url: "git@gitlab.intelliflow.in:intelliflow/intelliflowapp.git"}

            // ... add other repos similarly
        ];

        function populateTable() {
            const tableBody = document.getElementById('reposTableBody');
            repos.forEach(repo => {
                const row = document.createElement('tr');

                // Name column
                const nameCell = document.createElement('td');
                nameCell.innerText = repo.url.split(':').pop().split('/').pop().replace('.git', '');
                row.appendChild(nameCell);

                // Branches dropdown
                const branchCell = document.createElement('td');
                const branchDropdown = document.createElement('select');
                fetchBranchesForRepo(repo.url, branchDropdown);
                branchCell.appendChild(branchDropdown);
                row.appendChild(branchCell);

                // Refresh branches button
                const refreshButton = document.createElement('button');
                refreshButton.innerText = 'Refresh';
                refreshButton.onclick = () => fetchBranchesForRepo(repo.url, branchDropdown);
                branchCell.appendChild(refreshButton);


                // Container Status column
                const statusCell = document.createElement('td');
                statusCell.innerText = 'Unknown';  // Default value, will be updated later
                row.appendChild(statusCell);

                const deployCell = document.createElement('td');
                const deployButton = document.createElement('button');
                deployButton.id = 'deploy-' + repo.url.split(':').pop().split('/').pop().replace('.git', '');
                deployButton.innerText = 'Deploy';
                deployButton.onclick = () => deploy(nameCell.innerText, branchCell.querySelector('select').value, statusCell);
                deployCell.appendChild(deployButton);
                row.appendChild(deployCell);

                // Remove Container button
                const removeContainerCell = document.createElement('td');
                const removeContainerButton = document.createElement('button');
                removeContainerButton.innerText = 'Remove Container';
                removeContainerButton.onclick = () => removeContainer(nameCell.innerText, statusCell);
                removeContainerCell.appendChild(removeContainerButton);
                row.appendChild(removeContainerCell);


                tableBody.appendChild(row);
            });
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // function deploy(repoName, branch, statusCell) {
        //     showLoading();
        //     fetch('/deploy', {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json'
        //         },
        //         body: JSON.stringify({ repo: `git@gitlab.intelliflow.in:intelliflow/${repoName}.git`, branch })
        //     })
        //         .then(response => response.json())
        //         .then(data => {
        //             hideLoading();
        //             if (data.portInfo) {
        //                 alert(`Deployed successfully. Access at: ${data.portInfo}`);
        //             } else {
        //                 alert(data.message);
        //             }
        //             fetchContainerStatusForRow(repoName, statusCell);
        //         })
        //         .catch((error) => {
        //             hideLoading();
        //             console.error('Error:', error);
        //         });
        // }

        function deploy(repoName, branch, statusCell) {
    showLoading();
    if (statusCell.innerText === 'exited') {
        // Remove container first if it's exited
        fetch('/remove-containers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ repoName })
        })
            .then(response => {
                if (response.ok) {
                    // Proceed to deploy once container is removed
                    deployContainer(repoName, branch, statusCell);
                } else {
                    throw new Error('Failed to remove container');
                }
            })
            .catch((error) => {
                hideLoading();
                console.error('Error:', error);
            });
    } else {
        deployContainer(repoName, branch, statusCell);
    }
}

function deployContainer(repoName, branch, statusCell) {
    fetch('/deploy', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ repo: `git@gitlab.intelliflow.in:intelliflow/${repoName}.git`, branch })
    })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.portInfo) {
                alert(`Deployed successfully. Access at: ${data.portInfo}`);
            } else {
                alert(data.message);
            }
            fetchContainerStatusForRow(repoName, statusCell);
        })
        .catch((error) => {
            hideLoading();
            console.error('Error:', error);
        });
}








        function removeContainer(repoName, statusCell) {
            showLoading();
            fetch('/remove-containers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ repoName })
            })
                .then(response => response.text())
                .then(data => {
                    hideLoading();
                    alert(data);
                    // Update the status of the specific row
                    fetchContainerStatusForRow(repoName, statusCell);
                })
                .catch((error) => {
                    hideLoading();
                    console.error('Error:', error);
                });
        }


        function fetchContainerStatus() {
            fetch('/containers')
                .then(response => response.json())
                .then(data => {
                    const rows = document.getElementById('reposTableBody').rows;
                    for (let i = 0; i < rows.length; i++) {
                        const repoNameCell = rows[i].cells[0];
                        const statusCell = rows[i].cells[2];
                        const repoName = repoNameCell.innerText;
                        const container = data.find(c => c.name === repoName);
                        if (container) {
                            if (container.status.includes("Up")) {
                                statusCell.innerText = "up";
                            } else if (container.status.includes("Exited")) {
                                statusCell.innerText = "exited";
                            } else {
                                statusCell.innerText = "down";
                            }
                        } else {
                            statusCell.innerText = "down";
                        }
                    }
                })
                .catch((error) => {
                    console.error('Error fetching container status:', error);
                });
        }

        function fetchContainerStatusForRow(repoName, statusCell) {
            fetch(`/containers?repoName=${repoName}`)
                .then(response => response.json())
                .then(data => {
                    const containerInfo = data[0]; // Since we're filtering by repoName, we should get only one result
                    if (containerInfo) {
                        const status = containerInfo.split(' ').slice(1).join(' ').trim(); // Extract everything after the repoName
                        statusCell.innerHTML = ''; // Clear the status cell
                        statusCell.innerText = status;

                        // If the container is not running, show the deploy button
                        if (!status.startsWith('Up')) {
                            const deployButton = document.createElement('button');
                            deployButton.innerText = 'Deploy';
                            deployButton.onclick = () => deploy(repoName, branchCell.querySelector('select').value, statusCell);
                            statusCell.appendChild(deployButton);
                        }
                    } else {
                        statusCell.innerText = 'down';
                    }
                })
                .catch((error) => {
                    console.error('Error fetching container status:', error);
                });
        }

        function   fetchBranchesForRepo(repoName, dropdown) {
            fetch(`/branches?repoName=${repoName}`)
                .then(response => response.json())
                .then(branches => {
                    dropdown.innerHTML = ''; // Clear existing options
                    branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch;
                        option.innerText = branch;
                        dropdown.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching branches:', error);
                });
        }


        // Populate the table when the page loads
        window.onload = () => {
            populateTable();
            fetchContainerStatus();
            // Refresh container status every 5 seconds
            setInterval(fetchContainerStatus, 5000);
        };

    </script>
</body>

</html>
